#!/usr/bin/env python3.11
"""
GitHub ActionsÁÆ°ÁêÜÂô®
Ë¥üË¥£CI/CDÂ∑•‰ΩúÊµÅÈÖçÁΩÆ„ÄÅÁõëÊéßÂíåÁÆ°ÁêÜ
"""

import logging
import requests
import yaml
from typing import Dict, Any, List, Optional
from datetime import datetime
from pathlib import Path


class GitHubActionsManager:
    """GitHub ActionsÁÆ°ÁêÜÂô®"""
    
    def __init__(self, config: Dict[str, Any]):
        """ÂàùÂßãÂåñGitHub ActionsÁÆ°ÁêÜÂô®
        
        Args:
            config: GitHubÈÖçÁΩÆ
        """
        self.config = config
        self.logger = logging.getLogger('project_bach.github_actions')
        
        # GitHubÈÖçÁΩÆ
        self.token = config['token']
        self.username = config['username']
        self.repo = config['publish_repo']
        self.base_url = config.get('base_url', 'https://api.github.com')
        
        # ËØ∑Ê±ÇÂ§¥
        self.headers = {
            'Authorization': f'token {self.token}',
            'Accept': 'application/vnd.github.v3+json',
            'User-Agent': 'Project-Bach-Actions/1.0'
        }
        
        self.logger.info("GitHub ActionsÁÆ°ÁêÜÂô®ÂàùÂßãÂåñÂÆåÊàê")
    
    def create_static_sync_workflow(self, workflow_dir: Path) -> Dict[str, Any]:
        """ÂàõÂª∫ÈùôÊÄÅËµÑÊ∫êÂêåÊ≠•Â∑•‰ΩúÊµÅ
        
        Args:
            workflow_dir: Â∑•‰ΩúÊµÅÁõÆÂΩï
            
        Returns:
            ÂàõÂª∫ÁªìÊûú
        """
        self.logger.info("ÂàõÂª∫ÈùôÊÄÅËµÑÊ∫êÂêåÊ≠•Â∑•‰ΩúÊµÅÈÖçÁΩÆ")
        
        try:
            # Á°Æ‰øùÂ∑•‰ΩúÊµÅÁõÆÂΩïÂ≠òÂú®
            workflow_dir.mkdir(parents=True, exist_ok=True)
            
            # ÁîüÊàêÈùôÊÄÅËµÑÊ∫êÂêåÊ≠•Â∑•‰ΩúÊµÅÈÖçÁΩÆ
            workflow_content = self._generate_static_sync_workflow()
            
            # ÂÜôÂÖ•Â∑•‰ΩúÊµÅÊñá‰ª∂
            workflow_file = workflow_dir / 'sync-static-assets.yml'
            workflow_file.write_text(workflow_content, encoding='utf-8')
            
            self.logger.info(f"ÈùôÊÄÅËµÑÊ∫êÂêåÊ≠•Â∑•‰ΩúÊµÅÊñá‰ª∂ÂàõÂª∫: {workflow_file}")
            
            return {
                'success': True,
                'workflow_file': str(workflow_file),
                'message': 'ÈùôÊÄÅËµÑÊ∫êÂêåÊ≠•Â∑•‰ΩúÊµÅÂàõÂª∫ÊàêÂäü'
            }
            
        except Exception as e:
            self.logger.error(f"ÂàõÂª∫ÈùôÊÄÅËµÑÊ∫êÂêåÊ≠•Â∑•‰ΩúÊµÅÂ§±Ë¥•: {str(e)}")
            return {
                'success': False,
                'message': f'ÂàõÂª∫ÈùôÊÄÅËµÑÊ∫êÂêåÊ≠•Â∑•‰ΩúÊµÅÂ§±Ë¥•: {str(e)}'
            }
    
    def create_pages_workflow(self, workflow_dir: Path) -> Dict[str, Any]:
        """ÂàõÂª∫GitHub PagesÂ∑•‰ΩúÊµÅÈÖçÁΩÆ
        
        Args:
            workflow_dir: Â∑•‰ΩúÊµÅÁõÆÂΩï
            
        Returns:
            ÂàõÂª∫ÁªìÊûú
        """
        self.logger.info("ÂàõÂª∫GitHub PagesÂ∑•‰ΩúÊµÅÈÖçÁΩÆ")
        
        try:
            # Á°Æ‰øùÂ∑•‰ΩúÊµÅÁõÆÂΩïÂ≠òÂú®
            workflow_dir.mkdir(parents=True, exist_ok=True)
            
            # ÁîüÊàêPagesÂ∑•‰ΩúÊµÅÈÖçÁΩÆ
            workflow_content = self._generate_pages_workflow()
            
            # ÂÜôÂÖ•Â∑•‰ΩúÊµÅÊñá‰ª∂
            workflow_file = workflow_dir / 'pages.yml'
            workflow_file.write_text(workflow_content, encoding='utf-8')
            
            self.logger.info(f"PagesÂ∑•‰ΩúÊµÅÊñá‰ª∂ÂàõÂª∫: {workflow_file}")
            
            return {
                'success': True,
                'workflow_file': str(workflow_file),
                'message': 'GitHub PagesÂ∑•‰ΩúÊµÅÂàõÂª∫ÊàêÂäü'
            }
            
        except Exception as e:
            self.logger.error(f"ÂàõÂª∫Â∑•‰ΩúÊµÅÂ§±Ë¥•: {str(e)}")
            return {
                'success': False,
                'message': f'ÂàõÂª∫Â∑•‰ΩúÊµÅÂ§±Ë¥•: {str(e)}'
            }
    
    def _generate_pages_workflow(self) -> str:
        """ÁîüÊàêPagesÂ∑•‰ΩúÊµÅYAMLÂÜÖÂÆπ"""
        workflow = {
            'name': 'Deploy to GitHub Pages',
            'on': {
                'push': {
                    'branches': ['gh-pages']
                },
                'workflow_dispatch': None
            },
            'permissions': {
                'contents': 'read',
                'pages': 'write',
                'id-token': 'write'
            },
            'concurrency': {
                'group': 'pages',
                'cancel-in-progress': False
            },
            'jobs': {
                'deploy': {
                    'environment': {
                        'name': 'github-pages',
                        'url': '${{ steps.deployment.outputs.page_url }}'
                    },
                    'runs-on': 'ubuntu-latest',
                    'steps': [
                        {
                            'name': 'Checkout',
                            'uses': 'actions/checkout@v4'
                        },
                        {
                            'name': 'Setup Pages',
                            'uses': 'actions/configure-pages@v4'
                        },
                        {
                            'name': 'Upload artifact',
                            'uses': 'actions/upload-pages-artifact@v3',
                            'with': {
                                'path': '.'
                            }
                        },
                        {
                            'name': 'Deploy to GitHub Pages',
                            'id': 'deployment',
                            'uses': 'actions/deploy-pages@v4'
                        }
                    ]
                }
            }
        }
        
        return yaml.dump(workflow, default_flow_style=False, allow_unicode=True, sort_keys=False)
    
    def _generate_static_sync_workflow(self) -> str:
        """ÁîüÊàêÈùôÊÄÅËµÑÊ∫êÂêåÊ≠•Â∑•‰ΩúÊµÅYAMLÂÜÖÂÆπ"""
        workflow = {
            'name': 'Sync Static Assets to GitHub Pages',
            'on': {
                'push': {
                    'branches': ['main'],
                    'paths': [
                        'static/**',
                        'templates/**'
                    ]
                },
                'workflow_dispatch': None
            },
            'permissions': {
                'contents': 'write',
                'actions': 'read'
            },
            'jobs': {
                'sync-static-assets': {
                    'runs-on': 'ubuntu-latest',
                    'steps': [
                        {
                            'name': 'Checkout main branch',
                            'uses': 'actions/checkout@v4',
                            'with': {
                                'ref': 'main',
                                'fetch-depth': 0
                            }
                        },
                        {
                            'name': 'Configure Git',
                            'run': '\n'.join([
                                'git config --global user.name "GitHub Actions"',
                                'git config --global user.email "actions@github.com"'
                            ])
                        },
                        {
                            'name': 'Checkout gh-pages branch',
                            'run': 'git checkout gh-pages'
                        },
                        {
                            'name': 'Create static directory if not exists',
                            'run': 'mkdir -p static'
                        },
                        {
                            'name': 'Sync static assets from main',
                            'run': '\n'.join([
                                'git checkout main -- static/',
                                'echo "‚úÖ Static assets synced from main branch"'
                            ])
                        },
                        {
                            'name': 'Check for changes',
                            'id': 'check-changes',
                            'run': '\n'.join([
                                'if git diff --quiet; then',
                                '  echo "changes=false" >> $GITHUB_OUTPUT',
                                '  echo "No changes to commit"',
                                'else',
                                '  echo "changes=true" >> $GITHUB_OUTPUT',
                                '  echo "Changes detected in static assets"',
                                'fi'
                            ])
                        },
                        {
                            'name': 'Commit and push changes',
                            'if': 'steps.check-changes.outputs.changes == \'true\'',
                            'run': '\n'.join([
                                'git add static/',
                                'git commit -m "üîÑ Auto-sync: Update static assets from main branch',
                                '',
                                '- Synced CSS, JS, and other static files',
                                '- Triggered by changes in main branch',
                                '- Auto-generated by GitHub Actions"',
                                'git push origin gh-pages'
                            ])
                        },
                        {
                            'name': 'Summary',
                            'run': '\n'.join([
                                'echo "### Static Assets Sync Summary üìä" >> $GITHUB_STEP_SUMMARY',
                                'echo "" >> $GITHUB_STEP_SUMMARY',
                                'if [ "${{ steps.check-changes.outputs.changes }}" = "true" ]; then',
                                '  echo "‚úÖ Static assets were updated and synced to gh-pages branch" >> $GITHUB_STEP_SUMMARY',
                                '  echo "üîó [View GitHub Pages](https://sleepycat233.github.io/Project_Bach/)" >> $GITHUB_STEP_SUMMARY',
                                'else',
                                '  echo "‚ÑπÔ∏è No changes detected in static assets" >> $GITHUB_STEP_SUMMARY',
                                'fi',
                                'echo "" >> $GITHUB_STEP_SUMMARY',
                                'echo "**Synced directories:**" >> $GITHUB_STEP_SUMMARY',
                                'echo "- `static/css/` - CSS stylesheets" >> $GITHUB_STEP_SUMMARY',
                                'echo "- `static/js/` - JavaScript files" >> $GITHUB_STEP_SUMMARY',
                                'echo "- `static/assets/` - Images and other assets" >> $GITHUB_STEP_SUMMARY'
                            ])
                        }
                    ]
                }
            }
        }
        
        return yaml.dump(workflow, default_flow_style=False, allow_unicode=True, sort_keys=False)
    
    def get_workflow_runs(self, workflow_id: Optional[str] = None, per_page: int = 10) -> Dict[str, Any]:
        """Ëé∑ÂèñÂ∑•‰ΩúÊµÅËøêË°åËÆ∞ÂΩï
        
        Args:
            workflow_id: Â∑•‰ΩúÊµÅIDÔºàÂèØÈÄâÔºâ
            per_page: ÊØèÈ°µËøîÂõûÊï∞Èáè
            
        Returns:
            Â∑•‰ΩúÊµÅËøêË°å‰ø°ÊÅØ
        """
        try:
            if workflow_id:
                url = f"{self.base_url}/repos/{self.username}/{self.repo}/actions/workflows/{workflow_id}/runs"
            else:
                url = f"{self.base_url}/repos/{self.username}/{self.repo}/actions/runs"
            
            params = {'per_page': per_page}
            
            response = requests.get(url, headers=self.headers, params=params, timeout=30)
            
            if response.status_code == 200:
                data = response.json()
                
                return {
                    'success': True,
                    'total_count': data['total_count'],
                    'workflow_runs': [
                        {
                            'id': run['id'],
                            'name': run['name'],
                            'status': run['status'],
                            'conclusion': run['conclusion'],
                            'created_at': run['created_at'],
                            'updated_at': run['updated_at'],
                            'run_number': run['run_number'],
                            'url': run['html_url']
                        }
                        for run in data['workflow_runs']
                    ]
                }
            else:
                return {
                    'success': False,
                    'message': f'Ëé∑ÂèñÂ∑•‰ΩúÊµÅËøêË°åÂ§±Ë¥•: {response.status_code}',
                    'error': response.text
                }
                
        except Exception as e:
            self.logger.error(f"Ëé∑ÂèñÂ∑•‰ΩúÊµÅËøêË°åÂºÇÂ∏∏: {str(e)}")
            return {
                'success': False,
                'message': f'Ëé∑ÂèñÂ∑•‰ΩúÊµÅËøêË°åÂºÇÂ∏∏: {str(e)}'
            }
    
    def trigger_workflow(self, workflow_id: str, ref: str = 'main', inputs: Optional[Dict] = None) -> Dict[str, Any]:
        """ÊâãÂä®Ëß¶ÂèëÂ∑•‰ΩúÊµÅ
        
        Args:
            workflow_id: Â∑•‰ΩúÊµÅID
            ref: ÂàÜÊîØÊàñÊ†áÁ≠æ
            inputs: ËæìÂÖ•ÂèÇÊï∞
            
        Returns:
            Ëß¶ÂèëÁªìÊûú
        """
        self.logger.info(f"ÊâãÂä®Ëß¶ÂèëÂ∑•‰ΩúÊµÅ: {workflow_id}")
        
        try:
            url = f"{self.base_url}/repos/{self.username}/{self.repo}/actions/workflows/{workflow_id}/dispatches"
            
            payload = {
                'ref': ref
            }
            
            if inputs:
                payload['inputs'] = inputs
            
            response = requests.post(url, headers=self.headers, json=payload, timeout=30)
            
            if response.status_code == 204:
                return {
                    'success': True,
                    'message': 'Â∑•‰ΩúÊµÅËß¶ÂèëÊàêÂäü',
                    'workflow_id': workflow_id,
                    'ref': ref
                }
            else:
                return {
                    'success': False,
                    'message': f'Â∑•‰ΩúÊµÅËß¶ÂèëÂ§±Ë¥•: {response.status_code}',
                    'error': response.text
                }
                
        except Exception as e:
            self.logger.error(f"Ëß¶ÂèëÂ∑•‰ΩúÊµÅÂºÇÂ∏∏: {str(e)}")
            return {
                'success': False,
                'message': f'Ëß¶ÂèëÂ∑•‰ΩúÊµÅÂºÇÂ∏∏: {str(e)}'
            }
    
    def monitor_workflow_run(self, run_id: int) -> Dict[str, Any]:
        """ÁõëÊéßÁâπÂÆöÁöÑÂ∑•‰ΩúÊµÅËøêË°å
        
        Args:
            run_id: ËøêË°åID
            
        Returns:
            ËøêË°åÁä∂ÊÄÅ‰ø°ÊÅØ
        """
        try:
            url = f"{self.base_url}/repos/{self.username}/{self.repo}/actions/runs/{run_id}"
            
            response = requests.get(url, headers=self.headers, timeout=10)
            
            if response.status_code == 200:
                run_data = response.json()
                
                # ËÆ°ÁÆóËøêË°åÊó∂Èïø
                created_at = datetime.fromisoformat(run_data['created_at'].replace('Z', '+00:00'))
                if run_data['updated_at']:
                    updated_at = datetime.fromisoformat(run_data['updated_at'].replace('Z', '+00:00'))
                    duration = (updated_at - created_at).total_seconds()
                else:
                    duration = (datetime.now() - created_at).total_seconds()
                
                return {
                    'success': True,
                    'run_id': run_data['id'],
                    'status': run_data['status'],
                    'conclusion': run_data['conclusion'],
                    'created_at': run_data['created_at'],
                    'updated_at': run_data['updated_at'],
                    'duration_seconds': duration,
                    'url': run_data['html_url'],
                    'workflow_name': run_data['name']
                }
            else:
                return {
                    'success': False,
                    'message': f'Ëé∑ÂèñËøêË°å‰ø°ÊÅØÂ§±Ë¥•: {response.status_code}'
                }
                
        except Exception as e:
            self.logger.error(f"ÁõëÊéßÂ∑•‰ΩúÊµÅËøêË°åÂºÇÂ∏∏: {str(e)}")
            return {
                'success': False,
                'message': f'ÁõëÊéßÂºÇÂ∏∏: {str(e)}'
            }
    
    def validate_workflow_config(self, workflow_content: str) -> Dict[str, Any]:
        """È™åËØÅÂ∑•‰ΩúÊµÅÈÖçÁΩÆ
        
        Args:
            workflow_content: Â∑•‰ΩúÊµÅYAMLÂÜÖÂÆπ
            
        Returns:
            È™åËØÅÁªìÊûú
        """
        try:
            # Ëß£ÊûêYAML
            workflow_data = yaml.safe_load(workflow_content)
            
            # Âü∫Êú¨ÁªìÊûÑÈ™åËØÅ
            required_keys = ['name', 'on', 'jobs']
            missing_keys = [key for key in required_keys if key not in workflow_data]
            
            if missing_keys:
                return {
                    'valid': False,
                    'message': f'Áº∫Â∞ëÂøÖÈúÄÂ≠óÊÆµ: {missing_keys}'
                }
            
            # È™åËØÅÊùÉÈôêËÆæÁΩÆÔºàÂØπ‰∫éPagesÂ∑•‰ΩúÊµÅÔºâ
            permissions = workflow_data.get('permissions', {})
            recommended_permissions = ['contents', 'pages', 'id-token']
            
            missing_permissions = [
                perm for perm in recommended_permissions 
                if perm not in permissions
            ]
            
            warnings = []
            if missing_permissions:
                warnings.append(f'Âª∫ËÆÆÊ∑ªÂä†ÊùÉÈôê: {missing_permissions}')
            
            return {
                'valid': True,
                'message': 'Â∑•‰ΩúÊµÅÈÖçÁΩÆÊúâÊïà',
                'warnings': warnings,
                'structure': {
                    'has_permissions': bool(permissions),
                    'job_count': len(workflow_data['jobs']),
                    'trigger_events': list(workflow_data['on'].keys()) if isinstance(workflow_data['on'], dict) else [workflow_data['on']]
                }
            }
            
        except yaml.YAMLError as e:
            return {
                'valid': False,
                'message': f'YAMLÊ†ºÂºèÈîôËØØ: {str(e)}'
            }
        except Exception as e:
            return {
                'valid': False,
                'message': f'È™åËØÅÂºÇÂ∏∏: {str(e)}'
            }
    
    def get_workflow_status_summary(self) -> Dict[str, Any]:
        """Ëé∑ÂèñÂ∑•‰ΩúÊµÅÁä∂ÊÄÅÊëòË¶Å
        
        Returns:
            Áä∂ÊÄÅÊëòË¶Å
        """
        try:
            # Ëé∑ÂèñÊúÄËøëÁöÑÂ∑•‰ΩúÊµÅËøêË°å
            runs_result = self.get_workflow_runs(per_page=20)
            
            if not runs_result['success']:
                return {
                    'success': False,
                    'message': 'Êó†Ê≥ïËé∑ÂèñÂ∑•‰ΩúÊµÅËøêË°å‰ø°ÊÅØ'
                }
            
            runs = runs_result['workflow_runs']
            
            # ÁªüËÆ°ÂêÑÁßçÁä∂ÊÄÅ
            status_counts = {}
            conclusion_counts = {}
            
            for run in runs:
                status = run['status']
                conclusion = run['conclusion']
                
                status_counts[status] = status_counts.get(status, 0) + 1
                if conclusion:
                    conclusion_counts[conclusion] = conclusion_counts.get(conclusion, 0) + 1
            
            # ËÆ°ÁÆóÊàêÂäüÁéá
            total_completed = sum(conclusion_counts.values())
            success_rate = 0
            if total_completed > 0:
                success_count = conclusion_counts.get('success', 0)
                success_rate = (success_count / total_completed) * 100
            
            return {
                'success': True,
                'summary': {
                    'total_runs': len(runs),
                    'status_breakdown': status_counts,
                    'conclusion_breakdown': conclusion_counts,
                    'success_rate_percent': round(success_rate, 1),
                    'last_run': runs[0] if runs else None
                }
            }
            
        except Exception as e:
            self.logger.error(f"Ëé∑ÂèñÁä∂ÊÄÅÊëòË¶ÅÂºÇÂ∏∏: {str(e)}")
            return {
                'success': False,
                'message': f'Ëé∑ÂèñÁä∂ÊÄÅÊëòË¶ÅÂºÇÂ∏∏: {str(e)}'
            }


if __name__ == '__main__':
    # ÊµãËØïGitHub ActionsÁÆ°ÁêÜÂô®
    test_config = {
        'token': 'test_token',
        'username': 'testuser',
        'publish_repo': 'project-bach-site',
        'base_url': 'https://api.github.com'
    }
    
    actions_manager = GitHubActionsManager(test_config)
    
    # ÊµãËØïÂ∑•‰ΩúÊµÅÈÖçÁΩÆÁîüÊàê
    test_workflow_dir = Path('./test_workflows')
    
    # ÊµãËØïÈùôÊÄÅËµÑÊ∫êÂêåÊ≠•Â∑•‰ΩúÊµÅ
    print("=== ÊµãËØïÈùôÊÄÅËµÑÊ∫êÂêåÊ≠•Â∑•‰ΩúÊµÅ ===")
    sync_result = actions_manager.create_static_sync_workflow(test_workflow_dir)
    
    if sync_result['success']:
        print(f"‚úÖ ÈùôÊÄÅËµÑÊ∫êÂêåÊ≠•Â∑•‰ΩúÊµÅÂàõÂª∫ÊàêÂäü: {sync_result['workflow_file']}")
        
        # È™åËØÅÂ∑•‰ΩúÊµÅÈÖçÁΩÆ
        sync_workflow_file = Path(sync_result['workflow_file'])
        if sync_workflow_file.exists():
            sync_workflow_content = sync_workflow_file.read_text()
            sync_validation = actions_manager.validate_workflow_config(sync_workflow_content)
            print(f"Â∑•‰ΩúÊµÅÈÖçÁΩÆÈ™åËØÅ: {'ÊúâÊïà' if sync_validation['valid'] else 'Êó†Êïà'}")
            
            if sync_validation.get('warnings'):
                print(f"Ë≠¶Âëä: {sync_validation['warnings']}")
    else:
        print(f"‚ùå ÈùôÊÄÅËµÑÊ∫êÂêåÊ≠•Â∑•‰ΩúÊµÅÂàõÂª∫Â§±Ë¥•: {sync_result['message']}")
    
    print("\n=== ÊµãËØïGitHub PagesÂ∑•‰ΩúÊµÅ ===")
    result = actions_manager.create_pages_workflow(test_workflow_dir)
    
    if result['success']:
        print(f"‚úÖ Â∑•‰ΩúÊµÅÊñá‰ª∂ÂàõÂª∫ÊàêÂäü: {result['workflow_file']}")
        
        # ÊµãËØïÈÖçÁΩÆÈ™åËØÅ
        workflow_file = Path(result['workflow_file'])
        if workflow_file.exists():
            workflow_content = workflow_file.read_text()
            validation = actions_manager.validate_workflow_config(workflow_content)
            print(f"Â∑•‰ΩúÊµÅÈÖçÁΩÆÈ™åËØÅ: {'ÊúâÊïà' if validation['valid'] else 'Êó†Êïà'}")
            
            if validation.get('warnings'):
                print(f"Ë≠¶Âëä: {validation['warnings']}")
    else:
        print(f"‚ùå Â∑•‰ΩúÊµÅÊñá‰ª∂ÂàõÂª∫Â§±Ë¥•: {result['message']}")
    
    print("‚úÖ GitHub ActionsÁÆ°ÁêÜÂô®ÊµãËØïÂÆåÊàê")