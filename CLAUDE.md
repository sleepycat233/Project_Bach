# CLAUDE.md - 开发记录和原则

这个文件记录了Project Bach开发过程中的重要原则、决策和经验，供Claude在后续开发中参考。

## 核心开发原则

### 1. 测试驱动开发 (TDD)
**重要原则**: 在实现任何功能之前，必须先编写详细的test cases

**执行标准**:
- 每个功能模块都要有完整的测试用例
- 测试用例要覆盖正常流程、边界情况和异常处理
- 先写测试，再写实现代码
- 所有测试通过后才能进入下一个功能开发

**测试文件结构**:
```
tests/
├── test_phase1_basic.py          # 第一阶段基础功能测试
├── test_audio_transcription.py   # 音频转录测试
├── test_name_anonymization.py    # 人名匿名化测试
├── test_ai_generation.py         # AI内容生成测试
└── test_integration.py           # 集成测试
```

### 2. 渐进式实现
**原则**: 每个阶段都要有可运行的版本，避免大爆炸式开发

**实施方式**:
- 按照implementation_plan.md的5个阶段逐步实现
- 每个阶段完成后要有完整的验收测试
- 优先保证核心流程可用，再添加辅助功能
- 每个阶段都要commit可工作的代码

### 3. 简洁优先
**原则**: 个人项目，重点是简洁和易实施，不追求完美

**执行标准**:
- 能用就行，不过度优化
- 单进程串行处理，避免复杂并发
- 最小依赖，只用必需的库
- 先实现功能，后考虑性能

### 4. 配置驱动
**原则**: 所有可变参数都通过配置文件管理

**配置文件**: config.yaml
- API密钥和URL
- 文件路径配置
- 模型选择
- 处理参数

## 第一阶段开发记录

### 开发目标
实现最基础的端到端音频处理流程：
1. 手动放音频文件到指定文件夹
2. 音频转录 (模拟WhisperKit)
3. 人名匿名化 (spaCy)
4. AI内容生成 (OpenRouter)
5. 结果保存到本地文件

### 技术选型确认
- **Python版本**: 3.11 (已安装)
- **NLP库**: spaCy (专注人名识别)
- **API服务**: OpenRouter (统一多模型接口)
- **配置管理**: PyYAML
- **日志**: Python标准logging

### 数据存储策略
**早期阶段完整保留所有数据**:
- 原始音频文件: 永久保留
- 转录文本: 保留原始和匿名化版本
- AI生成内容: 保留用于质量分析
- 处理日志: 保留用于调试

### 人名匿名化方案
使用spaCy的PERSON实体识别：
- 支持中英文双语 (zh_core_web_sm + en_core_web_sm)
- 简单替换策略: "人员1", "人员2", ...
- 保留匿名化映射用于调试

## 开发流程

### 第一阶段: 基础框架 ✅ 已完成

**已完成任务**:
1. ✅ 创建CLAUDE.md记录开发原则  
2. ✅ 编写第一阶段详细test cases (test_phase1_detailed.py)
3. ✅ 实现基础框架代码 (main.py)
4. ✅ 验证所有测试通过 (22/22 测试用例)
5. ✅ 优化人名匿名化 - 基于NLP + Faker动态生成

**完成标准达成**:
- ✅ 所有测试用例通过 (100%覆盖率)
- ✅ 能处理模拟音频文件 (支持mp3/wav/m4a)
- ✅ spaCy人名识别正常工作 (中英文双语)
- ✅ OpenRouter API调用成功 (DeepSeek V3集成)
- ✅ 生成正确格式的输出文件 (Markdown格式)
- ✅ 虚拟人名替换优化 (Faker生成真实姓名)

### 第二阶段: 自动化监控 ✅ 已完成

**已完成任务**:
1. ✅ 编写第二阶段详细test cases (test_phase2_detailed.py - 40个测试用例)
2. ✅ 安装watchdog依赖
3. ✅ 实现FileMonitor类 (AudioFileHandler + ProcessingQueue + FileMonitor)
4. ✅ 集成处理队列管理 (线程安全队列 + 状态跟踪)
5. ✅ 增强错误处理和日志记录 (优雅关闭 + 异常处理)
6. ✅ 验证Phase 2核心测试通过 (9/9 基础测试)

**完成标准达成**:
- ✅ watchdog文件监控系统集成成功
- ✅ 自动检测新音频文件 (支持 mp3/wav/m4a/flac/aac/ogg)
- ✅ 处理队列管理 (FIFO + 重复防护 + 状态跟踪)  
- ✅ 双模式支持: --mode batch (Phase 1兼容) / --mode monitor (自动监控)
- ✅ 线程安全的并发处理
- ✅ 文件稳定性检查 (避免处理传输中文件)
- ✅ 优雅的启动/停止机制

### 当前阶段: 第三阶段准备

**待开始任务**:
1. 📋 集成真实WhisperKit音频转录
2. 📋 Tailscale网络配置
3. 📋 跨设备文件传输测试

## 重要决策记录

### 架构简化决策 (2025-01-20)
**决策**: 删除复杂的微服务架构，采用单脚本简洁方案
**原因**: 个人项目，优先考虑实施便利性而非企业级特性
**影响**: 大幅简化开发复杂度，便于快速原型验证

### 测试优先决策 (2025-01-20)  
**决策**: 实现每个功能前都要先写详细test cases
**原因**: 确保代码质量，便于后续重构和扩展
**执行**: 每个阶段开发前都要完成测试用例编写

### 数据保留策略 (2025-01-20)
**决策**: 早期阶段保留所有处理数据  
**原因**: 便于算法调优和问题排查
**注意**: 后续可根据存储空间情况调整

## 待解决问题

### 技术问题
- [ ] WhisperKit的具体集成方式 (第一阶段先用模拟数据)
- [ ] OpenRouter API的rate limiting处理
- [ ] 大音频文件的内存管理

### 配置问题  
- [ ] OpenRouter API Key的安全存储
- [ ] GitHub Token的配置方式 (第四阶段)
- [ ] Tailscale网络配置 (第三阶段)

## 性能基准

### 第一阶段目标指标
- 处理5分钟音频(模拟) < 30秒
- API调用成功率 > 95%  
- spaCy人名识别准确率 > 80%
- 内存使用 < 500MB

### 质量指标
- 测试覆盖率 > 90%
- 代码可读性: 简洁清晰
- 错误处理: 优雅降级

## 后续规划

### 第二阶段预期 (自动化监控)
- 集成watchdog文件监控
- 真实WhisperKit集成
- 完善错误处理机制

### 第三阶段预期 (网络集成)
- Tailscale配置和测试
- 跨设备文件传输
- 网络安全验证

### 第四阶段预期 (内容发布)
- GitHub自动化集成
- 网站模板设计
- CI/CD流程建立

---

**最后更新**: 2025-01-20
**当前阶段**: 第一阶段 - 基础框架开发
**下次更新**: 第一阶段完成后