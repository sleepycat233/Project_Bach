# Project Bach å®‰å…¨å®¡æŸ¥æŠ¥å‘Š

**å®¡æŸ¥æ—¥æœŸ**: 2025å¹´1æœˆ24æ—¥  
**å®¡æŸ¥äºº**: Claude å®‰å…¨åˆ†æ  
**å®¡æŸ¥èŒƒå›´**: å®Œæ•´ä»£ç åº“å®‰å…¨å®¡è®¡  
**ç‰ˆæœ¬**: å½“å‰ä¸»åˆ†æ”¯

## æ‰§è¡Œæ‘˜è¦

**æ•´ä½“å®‰å…¨è¯„çº§**: âœ… **ä½åˆ°ä¸­ç­‰é£é™©** 

Project Bachåœ¨æ•æ„Ÿä¿¡æ¯ç®¡ç†æ–¹é¢å±•ç°äº†**è‰¯å¥½çš„å®‰å…¨å®è·µ**ï¼Œé€šè¿‡æ­£ç¡®çš„`.gitignore`é…ç½®é˜²æ­¢æ•æ„Ÿæ•°æ®è¢«æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿã€‚ä¸»è¦å®‰å…¨å…³æ³¨ç‚¹é›†ä¸­åœ¨è¾“å…¥éªŒè¯å’Œç½‘ç»œå®‰å…¨æ–¹é¢ï¼Œè€Œéå‡­æ®æš´éœ²ã€‚

### âœ… å·²è¯†åˆ«çš„è‰¯å¥½å®‰å…¨å®è·µ

1. **æ­£ç¡®çš„æ•æ„Ÿä¿¡æ¯ç®¡ç†** - APIå¯†é’¥å’Œæ•æ„Ÿé…ç½®æ­£ç¡®æ’é™¤åœ¨Gitä¹‹å¤–
2. **å®‰å…¨çš„é…ç½®ç®¡ç†** - `.env`å’Œ`config.yaml`æ–‡ä»¶æ­£ç¡®è¢«ç‰ˆæœ¬æ§åˆ¶å¿½ç•¥
3. **æ¨¡æ¿åŒ–è®¾ç½®** - ä»…æäº¤æ¨¡æ¿æ–‡ä»¶ï¼ŒçœŸå®æ•æ„Ÿä¿¡æ¯ä¿æŒæœ¬åœ°

### âš ï¸ é«˜ä¼˜å…ˆçº§é—®é¢˜: 3ä¸ª
### ğŸ”¶ ä¸­ä¼˜å…ˆçº§é—®é¢˜: 6ä¸ª  
### â„¹ï¸ ä½ä¼˜å…ˆçº§é—®é¢˜: 4ä¸ª

**å¤‡æ³¨**: ä¹‹å‰è¯†åˆ«çš„"å…³é”®"å‡­æ®æš´éœ²æ˜¯**è¯¯æŠ¥**ã€‚åŒ…å«çœŸå®APIå¯†é’¥çš„æ–‡ä»¶ï¼ˆ`.env`å’Œ`config.yaml`ï¼‰é€šè¿‡`.gitignore`è§„åˆ™æ­£ç¡®æ’é™¤åœ¨Gitè·Ÿè¸ªä¹‹å¤–ã€‚

---

## ğŸ” æ•æ„Ÿä¿¡æ¯ç®¡ç†éªŒè¯

**âœ… ç¡®è®¤å®‰å…¨**:
- `.env`å’Œ`config.yaml`åœ¨`.gitignore`ä¸­ï¼ˆç¬¬58è¡Œã€ç¬¬64è¡Œï¼‰
- `git check-ignore`ç¡®è®¤è¿™äº›æ–‡ä»¶è¢«å¿½ç•¥
- ä»…è·Ÿè¸ªæ¨¡æ¿æ–‡ä»¶ï¼ˆ`.env.template`ã€`config.template.yaml`ï¼‰
- Gitå†å²ä¸­æœªå‘ç°æ•æ„Ÿæ•°æ®

**åŒ…å«æ•æ„Ÿä¿¡æ¯çš„æ–‡ä»¶**ï¼ˆä»…æœ¬åœ°ï¼‰:
- `.env` - åŒ…å«çœŸå®APIå¯†é’¥ä½†ä¸è¢«Gitè·Ÿè¸ª âœ…
- `config.yaml` - åŒ…å«å¸¦æ•æ„Ÿä¿¡æ¯çš„é…ç½®ä½†ä¸è¢«Gitè·Ÿè¸ª âœ…

**æ¨¡æ¿æ–‡ä»¶**ï¼ˆGitå®‰å…¨ï¼‰:
- `.env.template` - åŒ…å«å ä½ç¬¦å€¼ âœ…
- `config.template.yaml` - åŒ…å«å ä½ç¬¦å€¼ âœ…

---

## ğŸ”¥ å…³é”®æ¼æ´

### 1. **ç”Ÿäº§ç¯å¢ƒä¸­çš„é»˜è®¤å¼€å‘å¯†é’¥**

**ä¸¥é‡ç¨‹åº¦**: ğŸ”¥ å…³é”®  
**ä½ç½®**: `src/web_frontend/app.py:38`

**é—®é¢˜**: å¦‚æœç¯å¢ƒå˜é‡æœªè®¾ç½®ï¼Œå¯é¢„æµ‹çš„å›é€€å¯†é’¥å¯èƒ½åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è¢«ä½¿ç”¨ï¼š

```python
'SECRET_KEY': os.environ.get('FLASK_SECRET_KEY', 'dev-secret-key-change-in-production')
```

**å½±å“**: ä¼šè¯åŠ«æŒã€CSRFä»¤ç‰Œé¢„æµ‹ã€è®¤è¯ç»•è¿‡

---

## âš ï¸ é«˜ä¼˜å…ˆçº§æ¼æ´

### 2. **æ–‡ä»¶ä¸Šä¼ è¾“å…¥éªŒè¯ä¸è¶³**

**ä¸¥é‡ç¨‹åº¦**: âš ï¸ é«˜  
**ä½ç½®**: `src/web_frontend/handlers/audio_upload_handler.py:82-84`

**é—®é¢˜**: æ–‡ä»¶æ‰©å±•åéªŒè¯ä»…ä¾èµ–æ–‡ä»¶åï¼Œè€Œéå†…å®¹ï¼š

```python
filename = secure_filename(file.filename)
if not filename:
    filename = f"upload_{uuid.uuid4().hex[:8]}.mp3"  # å‡è®¾ä¸ºå®‰å…¨æ‰©å±•å
```

**é£é™©**: æ¶æ„æ–‡ä»¶ä¸Šä¼ ï¼Œé€šè¿‡ä¼ªè£…å¯æ‰§è¡Œæ–‡ä»¶å¯èƒ½å®ç°è¿œç¨‹ä»£ç æ‰§è¡Œ

**å»ºè®®**: å®æ–½MIMEç±»å‹éªŒè¯å’Œæ–‡ä»¶å¤´åˆ†æ

### 3. **ç§æœ‰å†…å®¹è®¿é—®ä¸­çš„è·¯å¾„éå†æ¼æ´**

**ä¸¥é‡ç¨‹åº¦**: âš ï¸ é«˜  
**ä½ç½®**: `src/web_frontend/app.py:1131-1138`

**é—®é¢˜**: è·¯å¾„éªŒè¯ä¸è¶³å¯èƒ½å…è®¸ç›®å½•éå†ï¼š

```python
safe_path = private_root / filepath
try:
    safe_path = safe_path.resolve()
    private_root_resolved = private_root.resolve()
    if not str(safe_path).startswith(str(private_root_resolved)):
        return "Access denied", 403
```

**é£é™©**: è®¿é—®é¢„æœŸç›®å½•ä¹‹å¤–çš„æ–‡ä»¶

### 4. **åŸºäºIPçš„Tailscaleè®¤è¯è–„å¼±**

**ä¸¥é‡ç¨‹åº¦**: âš ï¸ é«˜  
**ä½ç½®**: `src/web_frontend/app.py:82-106`

**é—®é¢˜**: ä»…ä¾èµ–IPåœ°å€éªŒè¯è¿›è¡Œå®‰å…¨æ§åˆ¶ï¼š

```python
client_ip = ipaddress.ip_address(remote_ip)
if client_ip not in tailscale_network:
    # æ‹’ç»è®¿é—®
```

**é£é™©**: IPæ¬ºéª—ã€åˆæ³•ç”¨æˆ·è¢«é˜»æ­¢ã€è®¿é—®æ§åˆ¶ä¸è¶³

---

## ğŸ”¶ ä¸­ä¼˜å…ˆçº§é—®é¢˜

### 5. **å­è¿›ç¨‹å‘½ä»¤æ³¨å…¥é£é™©**

**ä¸¥é‡ç¨‹åº¦**: ğŸ”¶ ä¸­ç­‰  
**ä½ç½®**: `src/web_frontend/handlers/youtube_handler.py:277-287`

**é—®é¢˜**: ç”¨æˆ·æä¾›çš„URLä¼ é€’ç»™å­è¿›ç¨‹æ—¶æœªå……åˆ†æ¸…ç†ï¼š

```python
cmd = ['yt-dlp', '--dump-json', '--no-download', url]
result = subprocess.run(cmd, capture_output=True, text=True, timeout=timeout)
```

**é£é™©**: å¦‚æœURLåŒ…å«shellå…ƒå­—ç¬¦ï¼Œå¯èƒ½å‘ç”Ÿå‘½ä»¤æ³¨å…¥

### 6. **é€Ÿç‡é™åˆ¶å®æ–½ä¸å½“**

**ä¸¥é‡ç¨‹åº¦**: ğŸ”¶ ä¸­ç­‰  
**ä½ç½®**: `src/web_frontend/app.py:73-74`

**é—®é¢˜**: é€Ÿç‡é™åˆ¶æœªæ­£ç¡®å®æ–½ï¼š

```python
app.config['SIMPLE_RATE_LIMIT'] = True  # æ³¨é‡Šè¯´éœ€è¦flask_limiter
```

**é£é™©**: DoSæ”»å‡»ã€APIæ»¥ç”¨ã€èµ„æºè€—å°½

### 7. **ä¸å®‰å…¨çš„ä¸´æ—¶æ–‡ä»¶å¤„ç†**

**ä¸¥é‡ç¨‹åº¦**: ğŸ”¶ ä¸­ç­‰  
**ä½ç½®**: å¤šä¸ªä½ç½®

**é—®é¢˜**: æ–‡ä»¶å­˜å‚¨åœ¨å¯é¢„æµ‹ä½ç½®ä¸”ç¼ºä¹å®‰å…¨æ¸…ç†ï¼š

```python
upload_dir = Path(app.config['UPLOAD_FOLDER'])  # /tmp/project_bach_uploads
```

**é£é™©**: ä¿¡æ¯æ³„éœ²ã€ç«äº‰æ¡ä»¶

### 8. **ç¼ºå°‘HTTPSå¼ºåˆ¶**

**ä¸¥é‡ç¨‹åº¦**: ğŸ”¶ ä¸­ç­‰  
**ä½ç½®**: åº”ç”¨ç¨‹åºé…ç½®

**é—®é¢˜**: ç”Ÿäº§éƒ¨ç½²æœªé…ç½®HTTPSå¼ºåˆ¶

**é£é™©**: ä¸­é—´äººæ”»å‡»ã€å‡­æ®æ‹¦æˆª

### 9. **è¯¦ç»†é”™è¯¯æ¶ˆæ¯**

**ä¸¥é‡ç¨‹åº¦**: ğŸ”¶ ä¸­ç­‰  
**ä½ç½®**: å¤šä¸ªå¼‚å¸¸å¤„ç†å™¨

**é—®é¢˜**: å‘ç”¨æˆ·æš´éœ²è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼š

```python
return jsonify({'error': f'Processing failed: {str(e)}'}), 500
```

**é£é™©**: ä¿¡æ¯æ³„éœ²ã€ç³»ç»ŸæŒ‡çº¹è¯†åˆ«

### 10. **å®‰å…¨äº‹ä»¶æ—¥å¿—è®°å½•ä¸è¶³**

**ä¸¥é‡ç¨‹åº¦**: ğŸ”¶ ä¸­ç­‰  
**ä½ç½®**: å®‰å…¨ä¸­é—´ä»¶

**é—®é¢˜**: ç”¨äºäº‹ä»¶å“åº”çš„å®‰å…¨äº‹ä»¶æ—¥å¿—è®°å½•æœ‰é™

**é£é™©**: å¨èƒæ£€æµ‹å»¶è¿Ÿã€å®¡è®¡è·Ÿè¸ªä¸è¶³

---

## â„¹ï¸ ä½ä¼˜å…ˆçº§é—®é¢˜

### 11. **ä¼šè¯ç®¡ç†è–„å¼±**

**ä¸¥é‡ç¨‹åº¦**: â„¹ï¸ ä½  
**ä½ç½®**: Flaské…ç½®

**é—®é¢˜**: æœªé…ç½®ä¼šè¯è¶…æ—¶æˆ–å®‰å…¨cookieè®¾ç½®

### 12. **ç¼ºå°‘å®‰å…¨å¤´**

**ä¸¥é‡ç¨‹åº¦**: â„¹ï¸ ä½  
**é—®é¢˜**: æœªå®æ–½CSPã€HSTSã€X-Frame-Optionsç­‰å®‰å…¨å¤´

### 13. **ä¾èµ–æ¼æ´** 

**ä¸¥é‡ç¨‹åº¦**: â„¹ï¸ ä½  
**é—®é¢˜**: åº”æ‰«æä¾èµ–é¡¹ä¸­çš„å·²çŸ¥æ¼æ´

### 14. **è°ƒè¯•æ¨¡å¼æ½œåœ¨é£é™©**

**ä¸¥é‡ç¨‹åº¦**: â„¹ï¸ ä½  
**ä½ç½®**: é…ç½®æ–‡ä»¶

**é—®é¢˜**: å­˜åœ¨å¯èƒ½åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ„å¤–å¯ç”¨çš„è°ƒè¯•æ ‡å¿—

---

## ğŸ›¡ï¸ å®‰å…¨ä¼˜åŠ¿

ä»£ç åº“å±•ç°äº†å¤šé¡¹å®‰å…¨æœ€ä½³å®è·µï¼š

### âœ… **å·²å®æ–½çš„è‰¯å¥½å®‰å…¨å®è·µ**

1. **è¾“å…¥æ¸…ç†**: å¯¹ä¸Šä¼ æ–‡ä»¶ä½¿ç”¨`secure_filename()`
2. **ç½‘ç»œéš”ç¦»**: Tailscaleé›†æˆç”¨äºç§æœ‰ç½‘ç»œè®¿é—®  
3. **éšç§æ§åˆ¶**: å…¬å…±/ç§æœ‰å†…å®¹åˆ†ç¦»
4. **æ–‡ä»¶ç±»å‹é™åˆ¶**: é™å®šå…è®¸çš„æ–‡ä»¶æ‰©å±•å
5. **CSRFä¿æŠ¤**: é»˜è®¤å¯ç”¨WTF CSRF
6. **å¤§å°é™åˆ¶**: æ–‡ä»¶ä¸Šä¼ å¤§å°é™åˆ¶ï¼ˆ500MBï¼‰
7. **é”™è¯¯å¤„ç†**: ç»“æ„åŒ–å¼‚å¸¸å¤„ç†
8. **è¿›ç¨‹éš”ç¦»**: åå°å¤„ç†çº¿ç¨‹

### âœ… **æ¶æ„å®‰å…¨æ€§**

1. **æ¨¡å—åŒ–è®¾è®¡**: æ¸…æ™°çš„å…³æ³¨ç‚¹åˆ†ç¦»
2. **é…ç½®ç®¡ç†**: é›†ä¸­åŒ–é…ç½®å¤„ç†
3. **APIé€Ÿç‡é™åˆ¶**: æ¡†æ¶å·²å°±ä½ï¼ˆéœ€è¦å®æ–½ï¼‰
4. **å†…å®¹éªŒè¯**: å¤šå±‚éªŒè¯

---

## ğŸš¨ ç«‹å³è¡ŒåŠ¨è®¡åˆ’

### **é˜¶æ®µ1: é«˜ä¼˜å…ˆçº§ï¼ˆ1å‘¨å†…ï¼‰**

1. **ä¿®å¤Flaskå¯†é’¥**
   ```python
   # ç¡®ä¿ç”Ÿäº§ç¯å¢ƒä¸­å§‹ç»ˆè®¾ç½®FLASK_SECRET_KEY
   if not os.environ.get('FLASK_SECRET_KEY'):
       raise ValueError("ç”Ÿäº§ç¯å¢ƒä¸­å¿…é¡»è®¾ç½®FLASK_SECRET_KEYç¯å¢ƒå˜é‡")
   ```

2. **éªŒè¯æ•æ„Ÿä¿¡æ¯ç®¡ç†** âœ… å·²å®æ–½
   - `.env`å’Œ`config.yaml`è¢«Gitæ­£ç¡®å¿½ç•¥
   - æ¨¡æ¿æ–‡ä»¶æä¾›å®‰å…¨è®¾ç½®æŒ‡å¯¼
   - æ— éœ€æ¸…ç† - ç³»ç»Ÿæ˜¯å®‰å…¨çš„

3. **æ–‡æ¡£åŒ–å®‰å…¨è®¾ç½®**
   ```bash
   # æ·»åŠ åˆ°README - å®‰å…¨è®¾ç½®éªŒè¯
   echo "# å®‰å…¨éªŒè¯" >> SECURITY.md
   echo "è¿è¡Œ: git check-ignore .env config.yaml" >> SECURITY.md
   echo "ä¸¤ä¸ªæ–‡ä»¶éƒ½åº”è¢«åˆ—å‡ºï¼ˆè¢«Gitå¿½ç•¥ï¼‰" >> SECURITY.md
   ```

### **é˜¶æ®µ2: é«˜ä¼˜å…ˆçº§ï¼ˆ1å‘¨å†…ï¼‰**

1. **å¢å¼ºæ–‡ä»¶ä¸Šä¼ å®‰å…¨**
   ```python
   # å®æ–½MIMEç±»å‹éªŒè¯
   def validate_file_content(file):
       magic = python_magic.Magic(mime=True)
       mime_type = magic.from_buffer(file.read(1024))
       file.seek(0)  # é‡ç½®æ–‡ä»¶æŒ‡é’ˆ
       return mime_type in ALLOWED_MIME_TYPES
   ```

2. **ä¿®å¤è·¯å¾„éå†**
   ```python
   # æ›´å¼ºçš„è·¯å¾„éªŒè¯
   def validate_safe_path(base_path, user_path):
       real_base = os.path.realpath(base_path)
       real_path = os.path.realpath(os.path.join(base_path, user_path))
       return real_path.startswith(real_base)
   ```

3. **å®æ–½é€‚å½“çš„é€Ÿç‡é™åˆ¶**
   ```python
   from flask_limiter import Limiter
   from flask_limiter.util import get_remote_address
   
   limiter = Limiter(
       app,
       key_func=get_remote_address,
       default_limits=["60 per minute"]
   )
   ```

### **é˜¶æ®µ3: ä¸­ä¼˜å…ˆçº§ï¼ˆ2-3å‘¨å†…ï¼‰**

1. **å®‰å…¨å¤´**
2. **HTTPSå¼ºåˆ¶** 
3. **å¢å¼ºæ—¥å¿—è®°å½•**
4. **è¾“å…¥æ¸…ç†æ”¹è¿›**
5. **ä¼šè¯å®‰å…¨**

---

## ğŸ”§ æ¨èçš„å®‰å…¨å·¥å…·

### **é™æ€åˆ†æ**
```bash
pip install bandit safety semgrep
bandit -r src/
safety check
semgrep --config=auto src/
```

### **ä¾èµ–æ‰«æ**
```bash
pip-audit
npm audit  # å¦‚æœä½¿ç”¨npm
```

### **å¯†é’¥æ£€æµ‹**
```bash
git-secrets --install
truffleHog --regex --entropy=False .
```

---

## ğŸ“‹ å®‰å…¨æ£€æŸ¥æ¸…å•

### **ç«‹å³æ‰§è¡Œï¼ˆå…³é”®ï¼‰**
- [x] ~~æ’¤é”€æ‰€æœ‰æš´éœ²çš„APIå¯†é’¥å’Œä»¤ç‰Œ~~ - è¯¯æŠ¥ï¼šå‡­æ®ç®¡ç†å®‰å…¨
- [x] ~~ä»ç‰ˆæœ¬æ§åˆ¶ä¸­ç§»é™¤æ•æ„Ÿä¿¡æ¯~~ - å·²æ­£ç¡®å®æ–½
- [x] ~~å®æ–½åŸºäºç¯å¢ƒçš„æ•æ„Ÿä¿¡æ¯ç®¡ç†~~ - å·²æ­£ç¡®å®æ–½
- [x] ~~æ›´æ–°.gitignoreé˜²æ­¢æœªæ¥æš´éœ²~~ - å·²æ­£ç¡®å®æ–½
- [ ] ä¿®å¤Flaskå¯†é’¥å›é€€é—®é¢˜
- [ ] éªŒè¯ç”Ÿäº§ç¯å¢ƒé…ç½®

### **çŸ­æœŸï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰**
- [ ] ä¿®å¤è·¯å¾„éå†æ¼æ´
- [ ] å®æ–½é€‚å½“çš„æ–‡ä»¶å†…å®¹éªŒè¯
- [ ] æ·»åŠ ç»¼åˆè¾“å…¥æ¸…ç†
- [ ] å®æ–½é€Ÿç‡é™åˆ¶
- [ ] é…ç½®å®‰å…¨ä¼šè¯ç®¡ç†
- [ ] æ·»åŠ å®‰å…¨å¤´

### **ä¸­æœŸ**
- [ ] å®æ–½ç»¼åˆå®¡è®¡æ—¥å¿—è®°å½•
- [ ] æ·»åŠ ä¾èµ–æ¼æ´æ‰«æ
- [ ] é…ç½®HTTPSå¼ºåˆ¶
- [ ] å®æ–½é€‚å½“çš„é”™è¯¯å¤„ç†
- [ ] æ·»åŠ å®‰å…¨æµ‹è¯•åˆ°CI/CD
- [ ] åˆ›å»ºäº‹ä»¶å“åº”ç¨‹åº

---

## ğŸ“ ç»“è®º

Project Bachåœ¨**æ•æ„Ÿä¿¡æ¯ç®¡ç†æ–¹é¢è¡¨ç°å‡ºè‰²**ï¼Œæ­£ç¡®å®æ–½äº†Gitå¿½ç•¥è§„åˆ™å’Œæ¨¡æ¿åŒ–é…ç½®ã€‚ä¸»è¦å®‰å…¨å…³æ³¨ç‚¹é›†ä¸­åœ¨è¾“å…¥éªŒè¯å’Œç½‘ç»œå®‰å…¨æ–¹é¢ã€‚

è™½ç„¶é¡¹ç›®å±•ç°äº†è‰¯å¥½çš„æ¶æ„å®è·µå¹¶åŒ…å«äº†å¤šé¡¹å®‰å…¨æªæ–½ï¼Œä½†è¾“å…¥éªŒè¯å’Œä¼šè¯ç®¡ç†æ–¹é¢çš„åŸºæœ¬é—®é¢˜éœ€è¦ä¼˜å…ˆè§£å†³ã€‚

**å»ºè®®**: é¡¹ç›®çš„æ•æ„Ÿä¿¡æ¯ç®¡ç†æ˜¯å®‰å…¨çš„ï¼Œå¯ä»¥ä¸“æ³¨äºä¿®å¤è¾“å…¥éªŒè¯å’Œç½‘ç»œå®‰å…¨é—®é¢˜ï¼Œç„¶åå¯ä»¥å®‰å…¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒã€‚

---

**åç»­æ­¥éª¤**:
1. æ‰§è¡Œç«‹å³è¡ŒåŠ¨è®¡åˆ’
2. å®æ–½æ¨èçš„ä¿®å¤
3. è¿›è¡Œåç»­å®‰å…¨æµ‹è¯•
4. å»ºç«‹æŒç»­å®‰å…¨å®è·µ

**è”ç³»æ–¹å¼**: æœ‰å…³æ­¤å®‰å…¨å®¡æŸ¥çš„é—®é¢˜ï¼Œè¯·å‚è€ƒä¸Šè¿°æä¾›çš„å…·ä½“è¡Œå·å’Œä»£ç å¼•ç”¨ã€‚